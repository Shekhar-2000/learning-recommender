{% extends 'learning_system/base.html' %}

{% block title %}Teacher Dashboard - LearnSmart{% endblock %}

{% block content %}
<div class="teacher-header">
    <div class="content-card">
        <div class="welcome-section">
            <h1>
                <i class="fas fa-chalkboard-teacher"></i>
                Teacher Dashboard
            </h1>
            <p>Monitor student progress, manage courses, and track learning analytics.</p>
        </div>
        
        <div class="teacher-stats">
            <div class="stat-card">
                <div class="stat-icon">
                    <i class="fas fa-users"></i>
                </div>
                <div class="stat-content">
                    <h3>{{ total_students }}</h3>
                    <p>Total Students</p>
                </div>
            </div>
            
            <div class="stat-card">
                <div class="stat-icon">
                    <i class="fas fa-book"></i>
                </div>
                <div class="stat-content">
                    <h3>{{ total_courses }}</h3>
                    <p>Active Courses</p>
                </div>
            </div>
            
            <div class="stat-card">
                <div class="stat-icon">
                    <i class="fas fa-chart-line"></i>
                </div>
                <div class="stat-content">
                    <h3>{{ avg_performance }}%</h3>
                    <p>Avg. Performance</p>
                </div>
            </div>
            
            <div class="stat-card">
                <div class="stat-icon">
                    <i class="fas fa-clock"></i>
                </div>
                <div class="stat-content">
                    <h3>{{ total_engagement_hours }}h</h3>
                    <p>Total Learning Time</p>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="students-section">
    <div class="content-card">
        <div class="section-header">
            <h2>
                <i class="fas fa-user-graduate"></i>
                Student Management
            </h2>
            <p>View and manage your students' learning progress and performance.</p>
        </div>

        {% if students %}
            <div class="student-progress-table">
                <table class="table">
                    <thead>
                        <tr>
                            <th>Student</th>
                            <th>Average Score</th>
                            <th>Completed Quizzes</th>
                            <th>Total Quizzes</th>
                            <th>Completion Rate</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for progress in student_progress %}
                        <tr>
                            <td>
                                <div class="student-info">
                                    <div class="student-avatar">
                                        {{ progress.student.user.first_name|first|default:progress.student.user.username|first|upper }}
                                    </div>
                                    <div>
                                        <strong>{{ progress.student.user.first_name|default:"N/A" }} {{ progress.student.user.last_name|default:"" }}</strong>
                                        <br>
                                        <small class="text-muted">@{{ progress.student.user.username }}</small>
                                    </div>
                                </div>
                            </td>
                            <td>
                                <span class="score-badge score-{{ progress.avg_score|floatformat:0 }}">
                                    {{ progress.avg_score }}%
                                </span>
                            </td>
                            <td>{{ progress.completed_quizzes }}</td>
                            <td>{{ progress.total_quizzes }}</td>
                            <td>
                                <div class="progress-bar">
                                    <div class="progress-fill" style="width: '{{ progress.completion_rate }}%'" ></div>
                                    <span class="progress-text">{{ progress.completion_rate }}%</span>
                                </div>
                            </td>
                            <td>
                                <a href="#" class="btn btn-primary btn-sm">
                                    <i class="fas fa-eye"></i>
                                    View Details
                                </a>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        {% else %}
            <div class="empty-state">
                <div class="empty-icon">
                    <i class="fas fa-user-graduate"></i>
                </div>
                <h3>No Students Yet</h3>
                <p>Students will appear here once they register and start learning.</p>
            </div>
        {% endif %}
    </div>
</div>

<div class="teacher-actions">
    <div class="content-card">
        <h2>
            <i class="fas fa-tools"></i>
            Teacher Tools
        </h2>
        <div class="actions-grid">
            <a href="#" class="action-card">
                <div class="action-icon">
                    <i class="fas fa-plus"></i>
                </div>
                <h4>Create Course</h4>
                <p>Add new learning content</p>
            </a>
            
            <a href="#" class="action-card">
                <div class="action-icon">
                    <i class="fas fa-chart-bar"></i>
                </div>
                <h4>Analytics</h4>
                <p>View detailed reports</p>
            </a>
            
            <a href="#" class="action-card">
                <div class="action-icon">
                    <i class="fas fa-cog"></i>
                </div>
                <h4>Settings</h4>
                <p>Manage your preferences</p>
            </a>
            
            <a href="#" class="action-card">
                <div class="action-icon">
                    <i class="fas fa-question-circle"></i>
                </div>
                <h4>Help</h4>
                <p>Get support and guidance</p>
            </a>
        </div>
    </div>
</div>

{% endblock %}

<!-- Chatbot Button and Widget (always visible) -->
<style>
#faq-chatbot-toggle {
    position: fixed; bottom: 2.5rem; right: 2.5rem; z-index: 1100;
    background: linear-gradient(90deg,#007bff,#00c6ff); color: #fff; border: none;
    border-radius: 50%; width: 56px; height: 56px; box-shadow: 0 2px 8px #0002;
    font-size: 2em; display: flex; align-items: center; justify-content: center;
    cursor: pointer; transition: background 0.2s;
}
#faq-chatbot-toggle:hover { background: linear-gradient(90deg,#0056b3,#00aaff); }
#faq-chatbot {
    position: fixed; bottom: 2rem; right: 2rem; width: 340px; max-width: 95vw;
    background: #fff; border-radius: 16px; box-shadow: 0 4px 24px #0002; border: none; z-index: 1000;
    font-family: 'Segoe UI', Arial, sans-serif;
}
#faq-chatbot-header {
    background: linear-gradient(90deg,#007bff,#00c6ff); color: #fff;
    padding: 0.7rem 1.2rem; border-top-left-radius: 16px; border-top-right-radius: 16px;
    font-weight: bold; font-size: 1.1em; letter-spacing: 0.5px;
    box-shadow: 0 2px 8px #0001;
}
#faq-chatbot-messages {
    height: 200px; overflow-y: auto; padding: 0.7rem; background: #f8fafd;
    font-size: 1em; border-bottom: 1px solid #eee;
}
.faq-msg {
    max-width: 80%; margin: 0.3em 0; padding: 0.5em 0.9em; border-radius: 12px;
    display: inline-block; word-break: break-word;
}
.faq-msg.user {
    background: #e3f0ff; color: #007bff; text-align: right; float: right;
    border-bottom-right-radius: 2px;
}
.faq-msg.bot {
    background: #fff; color: #222; text-align: left; float: left;
    border-bottom-left-radius: 2px;
    border: 1px solid #e0e0e0;
}
#faq-chatbot-form {
    display: flex; gap: 0.5rem; padding: 0.7rem; background: #f5f5f5;
    border-bottom-left-radius: 16px; border-bottom-right-radius: 16px;
    border-top: 1px solid #eee;
}
#faq-chatbot-input {
    flex: 1; padding: 0.5rem 0.7rem; border-radius: 8px; border: 1px solid #ccc;
    font-size: 1em; background: #f8fafd;
}
#faq-chatbot-form button {
    padding: 0.5rem 1.2rem; border-radius: 8px; border: none; background: #007bff; color: #fff;
    font-weight: bold; cursor: pointer; transition: background 0.2s;
}
#faq-chatbot-form button:hover {
    background: #0056b3;
}
</style>
<button id="faq-chatbot-toggle" title="Chatbot" aria-label="Toggle FAQ Chatbot">ðŸ’¬</button>
<div id="faq-chatbot" style="display:none;">
    <div id="faq-chatbot-header">FAQ Chatbot</div>
    <div id="faq-chatbot-messages"></div>
    <form id="faq-chatbot-form" method="post">
        {% csrf_token %}
        <input type="text" id="faq-chatbot-input" placeholder="Ask a question..." autocomplete="off" />
        <button type="submit">Send</button>
    </form>
</div>
<script>
document.getElementById('faq-chatbot-toggle').onclick = function() {
    var bot = document.getElementById('faq-chatbot');
    bot.style.display = bot.style.display === 'none' ? 'block' : 'none';
};
var form = document.getElementById('faq-chatbot-form');
var input = document.getElementById('faq-chatbot-input');
var messages = document.getElementById('faq-chatbot-messages');
function addMsg(text, sender) {
    var div = document.createElement('div');
    div.textContent = text;
    div.className = 'faq-msg ' + sender;
    messages.appendChild(div);
    messages.scrollTop = messages.scrollHeight;
    setTimeout(function(){div.style.opacity=1;},10);
    var clear = document.createElement('div'); clear.style.clear='both'; messages.appendChild(clear);
}
form.onsubmit = function(e){
    e.preventDefault();
    var q = input.value.trim();
    if(!q) return;
    addMsg(q, 'user');
    input.value = '';
        // Get CSRF token from form
        var csrfToken = document.querySelector('#faq-chatbot-form input[name="csrfmiddlewaretoken"]').value;
        fetch('/admin/faq-chatbot/', {
            method: 'POST',
            headers: {
                'X-Requested-With':'XMLHttpRequest',
                'Content-Type':'application/x-www-form-urlencoded',
                'X-CSRFToken': csrfToken
            },
            body: 'message=' + encodeURIComponent(q)
        }).then(r => r.json()).then(data => {
            addMsg(data.answer || 'No answer.', 'bot');
        }).catch(()=>{
            addMsg('Error contacting FAQ bot.', 'bot');
        });
};
</script>

<!-- Chatbot Button and Widget (always visible) -->
<style>
#faq-chatbot-toggle {
    position: fixed; bottom: 2.5rem; right: 2.5rem; z-index: 1100;
    background: linear-gradient(90deg,#007bff,#00c6ff); color: #fff; border: none;
    border-radius: 50%; width: 56px; height: 56px; box-shadow: 0 2px 8px #0002;
    font-size: 2em; display: flex; align-items: center; justify-content: center;
    cursor: pointer; transition: background 0.2s;
}
#faq-chatbot-toggle:hover { background: linear-gradient(90deg,#0056b3,#00aaff); }
#faq-chatbot {
    position: fixed; bottom: 2rem; right: 2rem; width: 340px; max-width: 95vw;
    background: #fff; border-radius: 16px; box-shadow: 0 4px 24px #0002; border: none; z-index: 1000;
    font-family: 'Segoe UI', Arial, sans-serif;
}
#faq-chatbot-header {
    background: linear-gradient(90deg,#007bff,#00c6ff); color: #fff;
    padding: 0.7rem 1.2rem; border-top-left-radius: 16px; border-top-right-radius: 16px;
    font-weight: bold; font-size: 1.1em; letter-spacing: 0.5px;
    box-shadow: 0 2px 8px #0001;
}
#faq-chatbot-messages {
    height: 200px; overflow-y: auto; padding: 0.7rem; background: #f8fafd;
    font-size: 1em; border-bottom: 1px solid #eee;
}
.faq-msg {
    max-width: 80%; margin: 0.3em 0; padding: 0.5em 0.9em; border-radius: 12px;
    display: inline-block; word-break: break-word;
}
.faq-msg.user {
    background: #e3f0ff; color: #007bff; text-align: right; float: right;
    border-bottom-right-radius: 2px;
}
.faq-msg.bot {
    background: #fff; color: #222; text-align: left; float: left;
    border-bottom-left-radius: 2px;
    border: 1px solid #e0e0e0;
}
#faq-chatbot-form {
    display: flex; gap: 0.5rem; padding: 0.7rem; background: #f5f5f5;
    border-bottom-left-radius: 16px; border-bottom-right-radius: 16px;
    border-top: 1px solid #eee;
}
#faq-chatbot-input {
    flex: 1; padding: 0.5rem 0.7rem; border-radius: 8px; border: 1px solid #ccc;
    font-size: 1em; background: #f8fafd;
}
#faq-chatbot-form button {
    padding: 0.5rem 1.2rem; border-radius: 8px; border: none; background: #007bff; color: #fff;
    font-weight: bold; cursor: pointer; transition: background 0.2s;
}

#faq-chatbot-form button:hover {
    background: #0056b3;
}
</style>

<button id="faq-chatbot-toggle" title="Chatbot" aria-label="Toggle FAQ Chatbot">ðŸ’¬</button>
<div id="faq-chatbot" style="display:none;">
    <div id="faq-chatbot-header">FAQ Chatbot</div>
    <div id="faq-chatbot-messages"></div>
    <form id="faq-chatbot-form">
        <input type="text" id="faq-chatbot-input" placeholder="Ask a question..." autocomplete="off" />
        <button type="submit">Send</button>
    </form>
</div>
<script>
document.getElementById('faq-chatbot-toggle').onclick = function() {
    var bot = document.getElementById('faq-chatbot');
    bot.style.display = bot.style.display === 'none' ? 'block' : 'none';
};
var form = document.getElementById('faq-chatbot-form');
var input = document.getElementById('faq-chatbot-input');
var messages = document.getElementById('faq-chatbot-messages');
function addMsg(text, sender) {
    var div = document.createElement('div');
    div.textContent = text;
    div.className = 'faq-msg ' + sender;
    messages.appendChild(div);
    messages.scrollTop = messages.scrollHeight;
    setTimeout(function(){div.style.opacity=1;},10);
    var clear = document.createElement('div'); clear.style.clear='both'; messages.appendChild(clear);
}
form.onsubmit = function(e){
    e.preventDefault();
    var q = input.value.trim();
    if(!q) return;
    addMsg(q, 'user');
    input.value = '';
    fetch('/admin/faq-chatbot/', {
        method: 'POST',
        headers: {'X-Requested-With':'XMLHttpRequest','Content-Type':'application/x-www-form-urlencoded'},
        body: 'message=' + encodeURIComponent(q)
    }).then(r => r.json()).then(data => {
        addMsg(data.answer || 'No answer.', 'bot');
    }).catch(()=>{
        addMsg('Error contacting FAQ bot.', 'bot');
    });
};
</script>