{% extends 'learning_system/base.html' %}

{% block title %}My Dashboard - LearnSmart{% endblock %}

{% block content %}
<div class="dashboard-header">
    <div class="content-card">
        <div class="welcome-section">
            <h1>
                <i class="fas fa-tachometer-alt"></i>
                Welcome back, {{ user.first_name|default:user.username }}!
            </h1>
            {% if not has_assessment %}
                <div class="assessment-prompt">
                    <div class="prompt-content">
                        <h3>
                            <i class="fas fa-magic"></i>
                            Get Personalized Recommendations!
                        </h3>
                        <p>Complete our quick assessment to receive personalized course recommendations tailored to your learning style and skill level.</p>
                        <a href="{% url 'initial_assessment' %}" class="btn btn-primary btn-lg">
                            <i class="fas fa-play"></i>
                            Start Assessment
                        </a>
                    </div>
                </div>
            {% else %}
                <p>Continue your learning journey and discover new opportunities to grow.</p>
                <div class="learning-level-badge">
                    <span class="level-badge level-{{ learning_level }}">
                        <i class="fas fa-star"></i>
                        {{ learning_level|title }} Level
                    </span>
                </div>
            {% endif %}
        </div>
        
        <div class="dashboard-stats">
            <div class="stat-card">
                <div class="stat-icon">
                    <i class="fas fa-book"></i>
                </div>
                <div class="stat-content">
                    <h3>{{ courses|length }}</h3>
                    <p>Available Courses</p>
                </div>
            </div>
            
            <div class="stat-card">
                <div class="stat-icon">
                    <i class="fas fa-trophy"></i>
                </div>
                <div class="stat-content">
                    <h3>{{ completed_quizzes }}</h3>
                    <p>Completed Quizzes</p>
                </div>
            </div>
            
            <div class="stat-card">
                <div class="stat-icon">
                    <i class="fas fa-clock"></i>
                </div>
                <div class="stat-content">
                    <h3>{{ total_time_hours }}h</h3>
                    <p>Learning Time</p>
                </div>
            </div>
            
            <div class="stat-card">
                <div class="stat-icon">
                    <i class="fas fa-chart-line"></i>
                </div>
                <div class="stat-content">
                    <h3>{{ avg_score }}%</h3>
                    <p>Average Score</p>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="courses-section">
    <div class="content-card">
        <div class="section-header">
            <h2>
                <i class="fas fa-graduation-cap"></i>
                Available Courses
            </h2>
            <p>Choose from our curated selection of courses designed to enhance your skills.</p>
        </div>

        {% if courses %}
            <div class="course-grid">
                {% for course in courses %}
                    <div class="course-card">
                        <div class="course-header">
                            <h3>{{ course.title }}</h3>
                            {% if course.tags %}
                                <div class="course-tags">
                                    <span class="tag">{{ course.tags }}</span>
                                </div>
                            {% endif %}
                        </div>
                        
                        <div class="course-content">
                            <p>{{ course.description|truncatewords:20 }}</p>
                        </div>
                        
                        <div class="course-actions">
                            <a href="{% url 'course_detail' course.id %}" class="btn btn-primary">
                                <i class="fas fa-eye"></i>
                                View Course
                            </a>
                        </div>
                    </div>
                {% endfor %}
            </div>
        {% else %}
            <div class="empty-state">
                <div class="empty-icon">
                    <i class="fas fa-book-open"></i>
                </div>
                <h3>No Courses Available</h3>
                <p>There are no courses available at the moment. Check back later for new content!</p>
            </div>
        {% endif %}
    </div>
</div>

<div class="quick-actions">
    <div class="content-card">
        <h2>
            <i class="fas fa-bolt"></i>
            Quick Actions
        </h2>
        <div class="actions-grid">
            <a href="{% url 'home' %}" class="action-card">
                <div class="action-icon">
                    <i class="fas fa-home"></i>
                </div>
                <h4>Home</h4>
                <p>Return to homepage</p>
            </a>
            
            <a href="#" class="action-card">
                <div class="action-icon">
                    <i class="fas fa-chart-line"></i>
                </div>
                <h4>Progress</h4>
                <p>View your learning progress</p>
            </a>
            
            <a href="#" class="action-card">
                <div class="action-icon">
                    <i class="fas fa-certificate"></i>
                </div>
                <h4>Certificates</h4>
                <p>View your achievements</p>
            </a>
            
            <a href="#" class="action-card">
                <div class="action-icon">
                    <i class="fas fa-cog"></i>
                </div>
                <h4>Settings</h4>
                <p>Manage your preferences</p>
            </a>
        </div>
    </div>
</div>

{% endblock %}

<!-- Chatbot Button and Widget (always visible) -->
<style>
#faq-chatbot-toggle {
    position: fixed; bottom: 2.5rem; right: 2.5rem; z-index: 1100;
    background: linear-gradient(90deg,#007bff,#00c6ff); color: #fff; border: none;
    border-radius: 50%; width: 56px; height: 56px; box-shadow: 0 2px 8px #0002;
    font-size: 2em; display: flex; align-items: center; justify-content: center;
    cursor: pointer; transition: background 0.2s;
}
#faq-chatbot-toggle:hover { background: linear-gradient(90deg,#0056b3,#00aaff); }
#faq-chatbot {
    position: fixed; bottom: 2rem; right: 2rem; width: 340px; max-width: 95vw;
    background: #fff; border-radius: 16px; box-shadow: 0 4px 24px #0002; border: none; z-index: 1000;
    font-family: 'Segoe UI', Arial, sans-serif;
}
#faq-chatbot-header {
    background: linear-gradient(90deg,#007bff,#00c6ff); color: #fff;
    padding: 0.7rem 1.2rem; border-top-left-radius: 16px; border-top-right-radius: 16px;
    font-weight: bold; font-size: 1.1em; letter-spacing: 0.5px;
    box-shadow: 0 2px 8px #0001;
}
#faq-chatbot-messages {
    height: 200px; overflow-y: auto; padding: 0.7rem; background: #f8fafd;
    font-size: 1em; border-bottom: 1px solid #eee;
}
.faq-msg {
    max-width: 80%; margin: 0.3em 0; padding: 0.5em 0.9em; border-radius: 12px;
    display: inline-block; word-break: break-word;
}
.faq-msg.user {
    background: #e3f0ff; color: #007bff; text-align: right; float: right;
    border-bottom-right-radius: 2px;
}
.faq-msg.bot {
    background: #fff; color: #222; text-align: left; float: left;
    border-bottom-left-radius: 2px;
    border: 1px solid #e0e0e0;
}
#faq-chatbot-form {
    display: flex; gap: 0.5rem; padding: 0.7rem; background: #f5f5f5;
    border-bottom-left-radius: 16px; border-bottom-right-radius: 16px;
    border-top: 1px solid #eee;
}
#faq-chatbot-input {
    flex: 1; padding: 0.5rem 0.7rem; border-radius: 8px; border: 1px solid #ccc;
    font-size: 1em; background: #f8fafd;
}
#faq-chatbot-form button {
    padding: 0.5rem 1.2rem; border-radius: 8px; border: none; background: #007bff; color: #fff;
    font-weight: bold; cursor: pointer; transition: background 0.2s;
}
#faq-chatbot-form button:hover {
    background: #0056b3;
}
</style>
<button id="faq-chatbot-toggle" title="Chatbot" aria-label="Toggle FAQ Chatbot">ðŸ’¬</button>
<div id="faq-chatbot" style="display:none;">
    <div id="faq-chatbot-header">FAQ Chatbot</div>
    <div id="faq-chatbot-messages"></div>
    <form id="faq-chatbot-form" method="post">
        {% csrf_token %}
        <input type="text" id="faq-chatbot-input" placeholder="Ask a question..." autocomplete="off" />
        <button type="submit">Send</button>
    </form>
</div>
<script>
document.getElementById('faq-chatbot-toggle').onclick = function() {
    var bot = document.getElementById('faq-chatbot');
    bot.style.display = bot.style.display === 'none' ? 'block' : 'none';
};
var form = document.getElementById('faq-chatbot-form');
var input = document.getElementById('faq-chatbot-input');
var messages = document.getElementById('faq-chatbot-messages');
function addMsg(text, sender) {
    var div = document.createElement('div');
    div.textContent = text;
    div.className = 'faq-msg ' + sender;
    messages.appendChild(div);
    messages.scrollTop = messages.scrollHeight;
    setTimeout(function(){div.style.opacity=1;},10);
    var clear = document.createElement('div'); clear.style.clear='both'; messages.appendChild(clear);
}
form.onsubmit = function(e){
    e.preventDefault();
    var q = input.value.trim();
    if(!q) return;
    addMsg(q, 'user');
    input.value = '';
        // Get CSRF token from form
        var csrfToken = document.querySelector('#faq-chatbot-form input[name="csrfmiddlewaretoken"]').value;
        fetch('/admin/faq-chatbot/', {
            method: 'POST',
            headers: {
                'X-Requested-With':'XMLHttpRequest',
                'Content-Type':'application/x-www-form-urlencoded',
                'X-CSRFToken': csrfToken
            },
            body: 'message=' + encodeURIComponent(q)
        }).then(r => r.json()).then(data => {
            addMsg(data.answer || 'No answer.', 'bot');
        }).catch(()=>{
            addMsg('Error contacting FAQ bot.', 'bot');
        });
};
</script>

<!-- Chatbot Button and Widget (always visible) -->
<style>
#faq-chatbot-toggle {
    position: fixed; bottom: 2.5rem; right: 2.5rem; z-index: 1100;
    background: linear-gradient(90deg,#007bff,#00c6ff); color: #fff; border: none;
    border-radius: 50%; width: 56px; height: 56px; box-shadow: 0 2px 8px #0002;
    font-size: 2em; display: flex; align-items: center; justify-content: center;
    cursor: pointer; transition: background 0.2s;
}
#faq-chatbot-toggle:hover { background: linear-gradient(90deg,#0056b3,#00aaff); }
#faq-chatbot {
    position: fixed; bottom: 2rem; right: 2rem; width: 340px; max-width: 95vw;
    background: #fff; border-radius: 16px; box-shadow: 0 4px 24px #0002; border: none; z-index: 1000;
    font-family: 'Segoe UI', Arial, sans-serif;
}
#faq-chatbot-header {
    background: linear-gradient(90deg,#007bff,#00c6ff); color: #fff;
    padding: 0.7rem 1.2rem; border-top-left-radius: 16px; border-top-right-radius: 16px;
    font-weight: bold; font-size: 1.1em; letter-spacing: 0.5px;
    box-shadow: 0 2px 8px #0001;
}
#faq-chatbot-messages {
    height: 200px; overflow-y: auto; padding: 0.7rem; background: #f8fafd;
    font-size: 1em; border-bottom: 1px solid #eee;
}
.faq-msg {
    max-width: 80%; margin: 0.3em 0; padding: 0.5em 0.9em; border-radius: 12px;
    display: inline-block; word-break: break-word;
}
.faq-msg.user {
    background: #e3f0ff; color: #007bff; text-align: right; float: right;
    border-bottom-right-radius: 2px;
}
.faq-msg.bot {
    background: #fff; color: #222; text-align: left; float: left;
    border-bottom-left-radius: 2px;
    border: 1px solid #e0e0e0;
}
#faq-chatbot-form {
    display: flex; gap: 0.5rem; padding: 0.7rem; background: #f5f5f5;
    border-bottom-left-radius: 16px; border-bottom-right-radius: 16px;
    border-top: 1px solid #eee;
}
#faq-chatbot-input {
    flex: 1; padding: 0.5rem 0.7rem; border-radius: 8px; border: 1px solid #ccc;
    font-size: 1em; background: #f8fafd;
}
#faq-chatbot-form button {
    padding: 0.5rem 1.2rem; border-radius: 8px; border: none; background: #007bff; color: #fff;
    font-weight: bold; cursor: pointer; transition: background 0.2s;
}

#faq-chatbot-form button:hover {
        background: #0056b3;
}
</style>

<button id="faq-chatbot-toggle" title="Chatbot" aria-label="Toggle FAQ Chatbot">ðŸ’¬</button>
<div id="faq-chatbot" style="display:none;">
        <div id="faq-chatbot-header">FAQ Chatbot</div>
        <div id="faq-chatbot-messages"></div>
        <form id="faq-chatbot-form">
                <input type="text" id="faq-chatbot-input" placeholder="Ask a question..." autocomplete="off" />
                <button type="submit">Send</button>
        </form>
</div>
<script>
document.getElementById('faq-chatbot-toggle').onclick = function() {
        var bot = document.getElementById('faq-chatbot');
        bot.style.display = bot.style.display === 'none' ? 'block' : 'none';
};
var form = document.getElementById('faq-chatbot-form');
var input = document.getElementById('faq-chatbot-input');
var messages = document.getElementById('faq-chatbot-messages');
function addMsg(text, sender) {
        var div = document.createElement('div');
        div.textContent = text;
        div.className = 'faq-msg ' + sender;
        messages.appendChild(div);
        messages.scrollTop = messages.scrollHeight;
        setTimeout(function(){div.style.opacity=1;},10);
        var clear = document.createElement('div'); clear.style.clear='both'; messages.appendChild(clear);
}
form.onsubmit = function(e){
        e.preventDefault();
        var q = input.value.trim();
        if(!q) return;
        addMsg(q, 'user');
        input.value = '';
        fetch('/admin/faq-chatbot/', {
                method: 'POST',
                headers: {'X-Requested-With':'XMLHttpRequest','Content-Type':'application/x-www-form-urlencoded'},
                body: 'message=' + encodeURIComponent(q)
        }).then(r => r.json()).then(data => {
                addMsg(data.answer || 'No answer.', 'bot');
        }).catch(()=>{
                addMsg('Error contacting FAQ bot.', 'bot');
        });
};
</script>